<!DOCTYPE html>
<html lang="en">

<!-- WARNING
    If Include the latest ver of A-F (1.3.0)
    A-marker-camera will fail to scan
    The reason is unknown
    There is no attempt to reproduce the issue as now
    Do remember to test regressively if update is needed for other functionality-->
<!-- To load GLTF v2.0 file, we use 0.7.0-->
<!-- To Update the material color of the brick, we use 0.8.2 -->
<!-- A Frame -->
<script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
<!--&lt;!&ndash; Ar.js &ndash;&gt;-->
<!--<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/dev/aframe/build/aframe-ar.js"></script>-->

<head>
    <meta charset="UTF-8">
    <title>Hybrid Cloud</title>
    <link rel="stylesheet" href="messageBox.css">

    <script>
      //modified from https://aframe.io/docs/1.3.0/introduction/models.html
      AFRAME.registerComponent('material-color', {

        init: function () {
          // Wait for model to load.
          this.el.addEventListener('model-loaded', () => {
            // Grab the mesh / scene.
            const obj = this.el.getObject3D('mesh');
            // Go over the submeshes and modify materials we want.
            obj.traverse(node => {
              console.log(node)
              console.log(node.material)
              node.material.color.set('red');
            });
          });
        }
      });

      //modified from https://stackoverflow.com/questions/51380941/aframe-size-of-model
      AFRAME.registerComponent('resize', {
        schema: {
          axis: {
            type: 'string',
            default: 'x'
          },
          value: {
            type: 'number',
            default: 1
          }
        },
        init: function() {
          var el = this.el;
          var data = this.data;
          var model = el.object3D;
          el.addEventListener('model-loaded', function(e) {
            var box = new THREE.Box3().setFromObject( model );
            var size = box.getSize();
            var x = size.x;
            var y = size.y;
            var z = size.z;
            if(data.axis === 'x') {
              var scale = data.value / x;
            }
            else if(data.axis === 'y') {
              var scale = data.value / y;
            }
            else {
              var scale = data.value / z;
            }
            el.setAttribute('scale', scale + ' ' + scale + ' ' + scale);
          });
        }
      });

    </script>
</head>
<body>

<input id="learnMore" type="button" onclick="openLearnMoreLink()" value="Learn more about this brick" />
<button id="choice1" type="button" onclick="addBrick2(document.getElementById('choice1').textContent)">multi-cluster management</button>
<button id="choice2" type="button" onclick="addBrick2(document.getElementById('choice2').textContent)">Security</button>

<div class="imessage">
    <p id="hint" class="from-me">Hello, let's build a brick world on the cloud!</p>
</div>



<a-scene>
    <a-assets>
        <a-asset-item id="redBrickModel" src="r.gltf"></a-asset-item>
    </a-assets>
<!--    <a-box position="-1 1 -4" rotation="0 0 0" color="#4CC3D9"></a-box>-->
<!--    <a-text value="fdsa" position="-1 1 -3" scale="1 1 1"></a-text>-->
<!--    <a-box position="0 1 -4" rotation="0 0 0" color="#4CC3D9"></a-box>-->
<!--    <a-box position="-0.5 2 -4" rotation="0 0 0" depth="1" height="1" width="2" color="#4CC3D9"></a-box>-->
    <a-entity resize='axis:x; value:1' gltf-model="#redBrickModel"></a-entity>
    <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane>
    <a-sky color="#ECECEC"></a-sky>
</a-scene>

<script type="text/javascript" src="brick.js"></script>
<script>



  let currentBrick = -1

  function changeHintText(text){
    if (typeof text !== "string"){
      console.error("The text to be set into hint box is not a string")
      return
    }

    let hintEl = document.getElementById("hint")
    hintEl.textContent= text
  }

  function addBrick2(brickName){
    if (isRightBrick(brickName)){
      let newBrick = document.createElement("a-entity")
      newBrick.setAttribute("position",calcPosition())
      newBrick.setAttribute("color",getColor())
      newBrick.setAttribute("gltf-model","#redBrickModel")
      newBrick.setAttribute("resize","'axis:x; value:1'")
      newBrick.setAttribute("material","shader: flat; color: red")
      // newBrick.setAttribute("material-color","color:#000000")
      // Wireframe is good for debugging
      // newBrick.setAttribute("wireframe","true")
      let sceneElement = document.querySelector("a-scene")
      sceneElement.appendChild(newBrick)

      addBrickText(brickName)

      currentBrick++
      pickNextChoices()
    }
    else{
      console.log("not right!")
    }
  }

  function addBrick(brickName){
    if (isRightBrick(brickName)){
      let newBrick = document.createElement("a-box")
      newBrick.setAttribute("position",calcPosition())
      newBrick.setAttribute("color",getColor())
      newBrick.setAttribute("width",getWidth())
      // Wireframe is good for debugging
      // newBrick.setAttribute("wireframe","true")
      let sceneElement = document.querySelector("a-scene")
      sceneElement.appendChild(newBrick)

      addBrickText(brickName)

      currentBrick++
      pickNextChoices()
    }
    else{
      console.log("not right!")
    }

  }

  function addBrickText(brickName){
    let text = bricks.brick[currentBrick+1].text

    let newText = document.createElement("a-text")
    newText.setAttribute("position",calcTextPosition())
    newText.setAttribute("color","rgba(255,255,255,0)")
    newText.setAttribute("value",addLineBreakToText(text))

    let sceneElement = document.querySelector("a-scene")
    sceneElement.appendChild(newText)
  }

  function pickNextChoices(){
    let button1 = document.getElementById("choice1")
    let button2 = document.getElementById("choice2")

    let nextBrickId = currentBrick+1
    let nextBrick = bricks.brick[nextBrickId]
    let choice1 = nextBrick.text

    let arrLength = bricks.brick.length
    let ranInt = randomInteger(0, arrLength - 1)
    let ranBrick = bricks.brick[ranInt]
    while (ranBrick.level === nextBrick.level) {
       ranInt = randomInteger(0, arrLength - 1)
       ranBrick = bricks.brick[ranInt]
    }
    let choice2 = bricks.brick[ranInt].text

    if (Math.random()>0.5 && nextBrickId!==arrLength-1){
      let swipe = choice2
      choice2 = choice1
      choice1 = swipe
    }

    button1.textContent = choice1;

    if (nextBrickId!==arrLength-1){
      button2.textContent = choice2;
    }else{
      button2.style.visibility = "hidden"
    }

  }

  // Min(Included) and Max(Included)
  function randomInteger(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function getColor(){
    let nextBrick = currentBrick+1

    let colorMap = ["#db3960",
      "#394792",
      "#6e7480",
      "#01ac69",
      "#98c5e4",
      "#ddb167",
      "#90b9cd"
    ]

    let level = bricks.brick[nextBrick].level
    if (!Number.isInteger(level) || level<0 || level>=colorMap.length){
      console.error("Level value of brick"+nextBrick.toString()+"is invalid")
    }

    return colorMap[level]
  }

  function getWidth(){
    let nextBrick = currentBrick+1

    let width = bricks.brick[nextBrick].size

    if (!Number.isInteger(width) || width<0){
      console.error("Width value of brick"+nextBrick.toString()+"is invalid")
    }

    return width
  }

  function calcPosition(){
    let nextBrick = currentBrick+1
    let x,y,z = 0
    z = -4

    let level = bricks.brick[nextBrick].level
    let startGrid = bricks.brick[nextBrick].startGrid
    let size = bricks.brick[nextBrick].size

    y = level+1
    x = startGrid+(size/2)
    positionStr = x.toString() + " "+ y.toString() + " "+ z.toString()
    return positionStr
  }

  function calcTextPosition(){
    let nextBrick = currentBrick+1
    let x,y,z = 0
    z = -3.5

    let level = bricks.brick[nextBrick].level
    let startGrid = bricks.brick[nextBrick].startGrid
    let size = bricks.brick[nextBrick].size

    y = level+1
    x = startGrid
    positionStr = x.toString() + " "+ y.toString() + " "+ z.toString()
    return positionStr
  }

  function isRightBrick(brickName){
    let nextBrick = currentBrick+1
    let nextBrickInfo = bricks.brick[nextBrick]

    if (nextBrickInfo.text.toUpperCase() === brickName.toUpperCase()){
      let congrText = ["Excellent!","Good!","Nice Job!","Yes!","Great Choice!"]
      let randInt =randomInteger(0,congrText.length-1)
      let randomCongrText = congrText[randInt]
      changeHintText(randomCongrText+" "+nextBrickInfo.introduction)
      return true
    }else{
      changeHintText("That's not quite right...")
      return false
    }
  }

  function addLineBreakToText(text){
    String.prototype.replaceAt = function(index, replacement) {
      if (index >= this.length) {
        return this.valueOf();
      }

      return this.substring(0, index) + replacement + this.substring(index + 1);
    }

    let linebreakThreshold = 5
    let firstSpacePosition = text.indexOf(" ")
    let secondSpacePosition = text.indexOf(" ",firstSpacePosition+1)

    if(firstSpacePosition===-1){
      return text
    }

    let midPos = text.length/2
    if (Math.abs(firstSpacePosition-midPos)<Math.abs(secondSpacePosition-midPos)){
       text = text.replaceAt(firstSpacePosition,"\n")
    }else{
      text = text.replaceAt(secondSpacePosition,"\n")
    }

    return text
  }

  function openLearnMoreLink(){
    let link = bricks.brick[currentBrick].link
    if (!isValidHttpUrl(link)){
      console.log("Link field of"+ +" is not a valid url")
        return
    }
    window.open(link,'_blank');
  }

  //modified from https://stackoverflow.com/questions/5717093/check-if-a-javascript-string-is-a-url
  function isValidHttpUrl(urlStr) {
    let urlObj;

    try {
      urlObj = new URL(urlStr);
    } catch (e) {
      return false;
    }

    return urlObj.protocol === "http:" || urlObj.protocol === "https:";
  }

  // alert(bricks.brick[0].text);
</script>
</body>
</html>
